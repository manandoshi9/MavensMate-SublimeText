{% extends "layouts/base.html" %}
{% block yield %}
<div id="result_output">
	<div id="result_wrapper" style="padding:0px 10px;">
		<div style="margin:5px 0px 15px 0px;" class="alert-message error">
			<p><strong id="error_message"></strong></p>
	  	</div>
	</div>
</div>

<div class="content">
		 
	<ul class="tabs">
		<li class="active"><a id="project_details_tab" href="#form" data-toggle="tab">Details</a></li>
		{% if user_action == "new" %}
		<li><a href="#metadata">Metadata</a></li>
		{% endif %}
	</ul>
	
	<div class="pill-content">
		<div id="form" class="active">
			<form class="form-stacked">
				<input type="hidden" value="" id="sid"/>
				<input type="hidden" value="" id="metadata_server_url"/>
				<input type="hidden" value="" id="server_url"/>
				<fieldset>
					<div class="clearfix">
						<label for="pn">Project Name</label> 
						<input class="xlarge" size="100" type="text" id="pn">
					</div>
					<div class="clearfix">
						<label for="un">Salesforce Username</label> 
						<input class="xlarge" size="100" type="text" id="un">
					</div>
					<div class="clearfix">
						<label for="pw">Salesforce Password</label> 
						<input class="xlarge" size="100" type="password" id="pw">
					</div>
					 <div class="clearfix">
						<label for="org_type">Salesforce Org Type</label> 
						<select id="org_type">
							<option value="production">Production</option>
							<option value="developer">Developer</option>
							<option value="sandbox">Sandbox</option>
							<option value="prerelease">Prerelease</option>
						</select>
					</div>  
				</fieldset>
			</form>
		</div>
		<!--
		<div id="vc">
			<div id="form" class="active">
				<form class="form-stacked">
					<fieldset>					   
						<div class="clearfix">
							<label for="vc_type">Version Control</label> 
							<select id="vc_type">  							
								<option>SVN</option>
								<option>Git</option>
							</select>
						</div>
						<div class="clearfix" id="svn_un_wrapper">
							<label for="svn_un">SVN Username</label> 
							<input class="xlarge" size="100" type="text" id="svn_un">
						</div>				
						<div class="clearfix" id="svn_pw_wrapper">
							<label for="svn_pw">SVN Password</label> 
							<input class="xlarge" size="100" type="password" id="svn_pw">
						</div>
						<div class="clearfix" id="git_alias_wrapper" style="display:none;">
							<label for="vc_alias">Git Alias</label> 
							<input class="xlarge" size="100" type="text" id="vc_alias"> 
						</div>   					
						<div class="clearfix" style="position:relative;">
							<label for="vc_url">URL</label> 
							<input style="padding-right:65px;" class="xlarge" size="100" type="text" id="vc_url">
                            <a href="#" id="btnExplore" onclick="get_vc_list();" class="btn small" style="position:absolute;top:24px;right:29px;padding:4px 7px 4px;">Explore</a>
						</div>
						<div class="clearfix" id="git_branch_wrapper" style="display:none;">
							<label for="vc_branch">Git Branch</label> 
							<input class="xlarge" size="100" type="text" id="vc_branch"> 
						</div>								
					    <div class="clearfix" style="position:relative;" id="vc_tree_wrapper">
							<div id="vc_tree" style="margin-top:5px;width:259px;border:1px solid #CCC;border-radius:3px;height:180px;overflow-y:auto;padding:5px;">

							</div>
							<div id="tree_loader" style="">
								<img src="file:///{{ base_path + '/lib/ui/resources/images/big_loading.gif' }}"/>
							</div> 
						</div>   
					</fieldset>
				</form>
			</div>
		</div>
		-->
		{% if user_action == "new" %}
		<div id="metadata">
			<!-- <div id="filter">
				<div class="select-wrapper" style="position:absolute;top:10px;left:5px;width:165px;text-align:right;">
					<a href="#" id="btnSelectAll" class="btn small" style="font-weight:normal;padding:4px 7px 4px;">All</a>
					<a href="#" id="btnDeselectAll" class="btn small" style="font-weight:normal;padding:4px 7px 4px;">None</a>
					<a href="javascript:void(0)" id="btnRefresh" style="font-weight:normal;padding:4px 7px 4px;" class="btn success small" onclick="refresh_index()">Refresh</a>
				</div>
			</div> -->
			<div id="project_wrapper">
				<div id="treewrapper">
					<div id="tree"></div>
					<div id="info"></div>
				</div> 
			</div>
		</div>
		{% endif %}		
	</div>
	
</div>

<form class="form-stacked" id="action_buttons">
	<fieldset style="padding-top:0px;">
		<div class="actions">					
			{% if user_action == "new" %}
				<input type="button" id="btnSubmit" class="btn primary" value="Create Project"  onclick='new_custom_project();'>
			{% endif %}
			{% if user_action == "checkout" %}
				<input type="button" id="btnSubmit" class="btn primary" value="Checkout Project"  onclick='checkout_project();'>
			{% endif %}
			&nbsp;
			<button type="reset" class="btn" onclick="window.close();">Cancel</button>
		</div>
	</fieldset>
</form>



	<script type="text/javascript">
		var response;
		var operation;
		var developer_metadata_types = ['ApexClass', 'ApexComponent', 'ApexTrigger', 'ApexPage', 'StaticResource']

		function new_custom_project() {
			operation = "new"
			$.ajax({
				type: "POST",
				dataType: 'json',
				contentType: 'application/json; charset=utf-8',
				url: "http://127.0.0.1:9000/project", 
				data: JSON.stringify({
					 project_name: $("#pn").val(), 
					 username: $("#un").val(), 
					 password: $("#pw").val(), 
					 org_type: $("#org_type").val(),
					 package: get_tree(),
					 action: "new"
				}),
				beforeSend: function() { showLoading('Creating new MavensMate project'); },
				complete: function(data){
					global_init_handler(data)
				} 
		 	});
		}

		function handle_response(response) {
			if (operation == "checkout" || operation == "new") {
				if (response["success"] == false) {
					$("#error_message").html(response["body"])
					$("#result_output").show()
				}
				hideLoading();
			} else if (operation == "check_creds") {
				if (response["success"] == false) {
					$("#error_message").html(response["body"])
					$("#result_output").show()
				} else {
					$('#sid').val(response["sid"])	
					$('#metadata_server_url').val(response["metadata_server_url"])
					$('#server_url').val(response["server_url"])
					$("#result_output").hide()
				}
				hideLoading();
			}
		}
	
		var user_action = "{{ user_action }}";
			
		$(function() {		   						
			$("#project_wrapper").height($(window).height() - 175)
			
			var resizeHeight = $("#form").height(); 
		    resizeAndCenterWindowByHeight(resizeHeight+250);
			
			$(window).resize(function() {
				$("#project_wrapper").height($(window).height() - 175)
			});
			
			//resize window if dom element is removed (in this case error message)
			$( "body" ).bind(
				"DOMNodeRemoved",
				function( event ) {
					if (event.target.id == "result_wrapper") {
						window.resizeTo(325, document.getElementById('wrapper').offsetHeight+72);
						$("#project_details_tab").click();
					}
				}
			);
									
			//submit form on enter
			$("#deploy_output").bind('keyup', function(e) {
				var code = (e.keyCode ? e.keyCode : e.which);
				 if(code == 13) { //enter pressed
				 	if ($('#un').val() && $('#pw').val() && $('#pn').val())
						$("#btnSubmit").click();
				 }
			}); 
			
			$('.tabs').tabs();
			
			//submit form on enter
			$(".content").bind('keyup', function(e) {
				var code = (e.keyCode ? e.keyCode : e.which);
				 if(code == 13) { //enter pressed
				 	if ($('#un').val() && $('#pw').val() && $('#pn').val())
						$("#btnSubmit").click();
				 }
			});  
			
			
			//when user changes tab to metadata selection, use provided creds to login and get session id
			$('.tabs a').bind('change', function (e) {
				console.log(e.target.href.indexOf("metadata"))
				if (e.target.href.indexOf("metadata") != -1 && user_action == "checkout") {
					//return;
				} else if (e.target.href.indexOf("metadata") != -1 && ($('#sid').val() == null || $('#sid').val() == "")) {
					console.log('checking creds');
					operation = "check_creds"
					$.ajax({
						type: "GET",
						url: "http://127.0.0.1:9000/session", 
						data: {
							 username: $("#un").val(), 
							 password: $("#pw").val(), 
							 org_type: $("#org_type").val()
						},
						beforeSend: function() { showLoading('Attempting to authenticate to Salesforce using the provided credentials'); },
						complete: function(data){
							console.log(data)
							try {
								var response = JSON.parse(data.responseText)
								if (response["success"] == false) {
									$("#project_details_tab").click();
									$("#error_message").html(response["body"])
									$("#result_output").show()
								} else {
									instantiate_metadata_tree(response["metadata"])
									$('#sid').val(response["sid"])	
									$('#metadata_server_url').val(response["metadata_server_url"])
									$('#server_url').val(response["server_url"])
									$("#result_output").hide()
								}
								hideLoading();
							} catch(e) {
								show_global_error('The local MavensMate server did not respond properly. This likely means it is not running or it is malfunctioning. If MavensMate.app is not running, please start it. Otherwise, try restarting MavensMate.app.');
								hideLoading();
							}
							
						}
				 	});
				}
		    });
			
			//dispatch({controller: 'project', action: 'start_tcp_server' });  
		});
		
		//shows an error if the user has not entered creds		
		function showCredAlert() {
			$("#cred_alert").show();
			window.resizeTo(325, document.getElementById('wrapper').offsetHeight+30);
		} 
				
		var tree_children = ""
		
		function instantiate_metadata_tree(metadata) {
			for (i in metadata['metadataObjects']) {
				metadata['metadataObjects'][i]['title'] = metadata['metadataObjects'][i]['xmlName']
				metadata['metadataObjects'][i]['isFolder'] = true
				metadata['metadataObjects'][i]['isLazy'] = true
				if (metadata['metadataObjects'][i]['childXmlNames'] === undefined || metadata['metadataObjects'][i]['childXmlNames'] === null) {
					metadata['metadataObjects'][i]['hasChildTypes'] = false
				} else {
					metadata['metadataObjects'][i]['hasChildTypes'] = true
				}
				if (developer_metadata_types.indexOf(metadata['metadataObjects'][i]['xmlName']) > -1) {
					console.log('good!')
					metadata['metadataObjects'][i]['select'] = true
				}
			}
			console.log(metadata)

			//instantiate and populate metadata tree				
	    	$("#tree").dynatree({
          		onQueryExpand: function(node) {
					//console.log($('#sid'))
					if ( $('#sid').val() == null || $('#sid').val() == "") {
						showCredAlert();
						return false;
					}
         		},
			 	dataType: "jsonp",
			 	onLazyRead: function(node) {
					node.appendAjax({url: "http://127.0.0.1:9000/metadata/list",
			  			data: {
							"metadata_type"			: node.data.title,
							"sid"					: $("#sid").val(),
							"metadata_server_url" 	: $("#metadata_server_url").val(),
							"server_url" 			: $("#server_url").val()
						},
						dataFilter: function (data, type) {
							console.log('processing data')
							console.log(data)
							try {
								var json_data = JSON.parse(data)
								for (i in json_data) {
									json_data[i]['title'] 		= json_data[i]['title']    	|| json_data[i]['fullName']
									json_data[i]['key'] 		= json_data[i]['key'] 		|| json_data[i]['fullName']
									json_data[i]['isFolder'] 	= json_data[i]['isFolder'] 	|| false
									json_data[i]['isLazy'] 		= json_data[i]['isLazy']   	|| false
								}
								var json_string = JSON.stringify(json_data);
								return json_string
							} catch(e) {
								return []
							}
						}
					});
			 	},
         		persist: false,
			 	checkbox: true,
			 	selectMode: 3,
				children: metadata['metadataObjects']
      		}); 
		}


	</script>
	<style>
		#result_output {
			display:none;
		}
	</style>
{% endblock %}