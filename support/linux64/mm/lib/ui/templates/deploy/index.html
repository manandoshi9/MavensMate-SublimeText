{% extends "layouts/base.html" %}
{% block yield %}
<style>
	.bordered-table, .bordered-table td {
	    -webkit-border-radius: 0px !important;
		border-radius: 0px !important;
	}

	.bordered-table {
		border-bottom:1px solid #ccc !important;
	}

	.chzn-choices {
		border-radius: 3px !important;
	}

	.deploy_options label, .deploy_options div.divlabel {
		width:180px;
		font-weight: bold;
	}

	.deploy_options label {
		text-align: left;
	}

	.deploy_options .clearfix {
		margin-left: 20px;
		margin-bottom:10px;
	}
	
	.deploy_options input[type="checkbox"] {
		margin: 0px;
		width: 32px;
		float: left;
	}
	.deploy_options .clearfix label > div {
		float: left;
		width: auto;
		font-weight: bold;
		padding-top: 5px;
		cursor: pointer;
	}	
	#filter {
		background-color:#f7f7f7;
		padding:5px;
		border:1px solid #ccc;
		border-bottom:none;
		position:relative;
	}

	.block-message-custom {
        background-image: none;
        background-color: #F2F2F2;
        filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
        padding: 14px;
        border-color: #CCC;
        -webkit-box-shadow: none;
        -moz-box-shadow: none;
        box-shadow: none;
    }    

	table.test_result {
		border-top:none;
	}
	table.test_result th, table.test_result td {
		padding:5px;
		line-height:1;
	}  

</style>
<div id="result_output">
	
</div>

<div class="content">
	
	<div class="alert-message error" style="display:none;" data-alert="alert" id="cred_alert">
		<a class="close" href="#"> x </a>
		<p><strong>Error!</strong> You need to provide valid Salesforce.com credentials in Project Details.</p>
	</div>

	
	<ul class="tabs">
		<li class="active"><a href="#form">Deploy Options</a></li>
		<li><a href="#connections">Org Connections</a></li>
		<li><a href="#metadata">Metadata</a></li>
		<li><a href="#result" id="result_tab">Result</a></li>
		<li><a href="#arcade" id="arcade_tab">Arcade</a></li>
	</ul>
	
	<div class="pill-content">
		<div id="form" class="active">
			<form class="form-stacked">
				<fieldset>
					<div class="clearfix">
						<label for="un_list">Deployment Targets</label> 
							<select style="width:90%;" id="un_list" multiple="multiple" data-placeholder="Select 1 or more connections...">
								{% for c in connections %}
									{% if loop.index0 == 0 %}
										{% set selected = 'selected="selected"' %}
									{% else %}
										{% set selected = '' %}
									{% endif %}
									<option {{ selected }} value="{{ c['username'] }};{{c['environment']}};{{c['id']}}">
										{{ c['username'] }}
									</option>
								{% endfor %} 
								<!-- <option value="new">-- Custom Connection --</option> -->
							</select>	
					</div>			
				</fieldset>
			</form>

			<form>
				<fieldset class="deploy_options" style="margin:0;padding-top:0px;">
					<div class="clearfix">
						<label for="check_only" >Validate Only</label>
						<input type="checkbox" id="check_only" style="margin:0px;width:32px;"/>
					</div>
					<div class="clearfix">
						<label for="run_tests" >Run Tests</label>
						<input type="checkbox" id="run_tests" style="margin:0px;width:32px;"/>
					</div>
					<div class="clearfix">
						<label for="rollback" >Rollback on Error</label>
						<input type="checkbox" id="rollback" style="margin:0px;width:32px;"/>			
					</div>
			    
					<div class="clearfix">
						<label for="select-Db" >Database Log Level</label>
						<select id="select-Db">
							<option value="">None</option>
							<option value="ERROR">ERROR</option>
							<option value="WARN">WARN</option>
							<option value="INFO">INFO</option>
							<option value="DEBUG">DEBUG</option>
							<option value="FINE">FINE</option>
							<option value="FINER">FINER</option>
							<option value="FINEST">FINEST</option>
						</select>
					</div>

					<div class="clearfix">
						<label for="select-Workflow" >Workflow Log Level</label>
						<select id="select-Workflow">
							<option value="">None</option>
							<option value="ERROR">ERROR</option>
							<option value="WARN">WARN</option>
							<option value="INFO">INFO</option>
							<option value="DEBUG">DEBUG</option>
							<option value="FINE">FINE</option>
							<option value="FINER">FINER</option>
							<option value="FINEST">FINEST</option>
						</select>
					</div>

					<div class="clearfix">
						<label for="select-Validation" >Validation Log Level</label>
						<select id="select-Validation">
							<option value="">None</option>
							<option value="ERROR">ERROR</option>
							<option value="WARN">WARN</option>
							<option value="INFO">INFO</option>
							<option value="DEBUG">DEBUG</option>
							<option value="FINE">FINE</option>
							<option value="FINER">FINER</option>
							<option value="FINEST">FINEST</option>
						</select>
					</div>

					<div class="clearfix">
						<label for="select-Callout" >Callout Log Level</label>
						<select id="select-Callout">
							<option value="">None</option>
							<option value="ERROR">ERROR</option>
							<option value="WARN">WARN</option>
							<option value="INFO">INFO</option>
							<option value="DEBUG">DEBUG</option>
							<option value="FINE">FINE</option>
							<option value="FINER">FINER</option>
							<option value="FINEST">FINEST</option>
						</select>
					</div>

					<div class="clearfix">
						<label for="select-Apex_code" >Apex Code Log Level</label>
						<select id="select-Apex_code">
							<option value="">None</option>
							<option value="ERROR">ERROR</option>
							<option value="WARN">WARN</option>
							<option value="INFO">INFO</option>
							<option value="DEBUG">DEBUG</option>
							<option value="FINE">FINE</option>
							<option value="FINER">FINER</option>
							<option value="FINEST">FINEST</option>
						</select>
					</div>

					<div class="clearfix">
						<label for="select-Apex_profiling" >Apex Profiling Log Level</label>
						<select id="select-Apex_profiling">
							<option value="">None</option>
							<option value="ERROR">ERROR</option>
							<option value="WARN">WARN</option>
							<option value="INFO">INFO</option>
							<option value="DEBUG">DEBUG</option>
							<option value="FINE">FINE</option>
							<option value="FINER">FINER</option>
							<option value="FINEST">FINEST</option>
						</select>
					</div>

				</fieldset>


			</form>
		</div>

		<div id="connections">
			<div id="error_wrapper" style="display:none">
				<div id="error" style="margin:5px 0px 15px 0px;" class="alert-message error">
					<p></p>
	  			</div>
			</div>
			<form class="form-stacked">
					<fieldset>	
				    <div id="connections_wrapper">
							<div class="alert-message block-message info">
					        	<p><strong>A deployment connection is a Salesforce.com org that you wish to deploy to from this MavensMate project.</strong></p>
					      	</div>
							<div class="alert-message block-message-custom" style="margin-bottom:0px;padding: 5px;-webkit-border-radius: 4px 4px 0px 0px;">
									<p style="float:left;"><strong>Deployment Connections</strong></p>
								<div style="clear:both;"></div>	
							</div>  
							<table class="bordered-table test_result" style="-webkit-border-radius: 0px 0px 4px 4px;">
								<thead>
									<tr>
										<th>Connection</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody id="connections_list">
									{% for c in connections %}
										<tr>
											<td>{{ c['username'] }} ({{c['environment']}})</td>
											<td>
												<a href="javascript:void(0);" onclick="deleteConnection('{{ c['id'] }}')">Remove</a>
											</td>
										</tr>
									{% endfor %}
								</tbody>
							</table>
					</div>
				</fieldset>
			</form>
			
			<div id="form" class="active">
				<form class="form-stacked">
					<fieldset>					   
						<div class="clearfix" id="svn_un_wrapper">
							<label for="connection-un">Salesforce Username</label> 
							<input class="xlarge" size="100" type="text" id="connection_un">
						</div>				
						<div class="clearfix" id="svn_pw_wrapper">
							<label for="connection-pw">Salesforce Password</label> 
							<input class="xlarge" size="100" type="password" id="connection_pw">
						</div>
						<div class="clearfix">
							<label for="org_type">Salesforce Org Type</label> 
							<select id="org_type">
								<option value="production">Production</option>
								<option value="developer">Developer</option>
								<option value="sandbox">Sandbox</option>
								<option value="prerelease">Prerelease</option>
							</select>
						</div>
						<div class="clearfix" style="margin-top:15px;">
							<input type="button" id="btnSubmit" class="btn primary" value="Create Connection" onclick="newConnection()">
						</div>
										
					</fieldset>
				</form>
			</div>
		</div>

		<div id="metadata">
			<script>
				$("#ptype").change(function() {
					if (this.value == "Custom") {
						$("#project_wrapper").show();
						$("#changesetwrapper").hide();
					} else {
						$("#project_wrapper").hide();
						$("#changesetwrapper").show();
					}
				})
			</script>
			<div id="filter">
					<input type="text" placeholder="Search for metadata" id="txtFilter" style="width:300px" />
					<a href="#" id="btnClearFilter" onclick="clearFilter();" class="btn small error" style="visibility:invisible;opacity:0;font-weight:bold;position:relative;top:1px;right:30px;padding:4px 7px 4px;">X</a>
					<div class="select-wrapper" style="position:absolute;top:10px;right:5px;width:165px;text-align:right;">
						<a href="#" id="btnSelectAll" class="btn small" style="font-weight:normal;padding:4px 7px 4px;">All</a>
						<a href="#" id="btnDeselectAll" class="btn small" style="font-weight:normal;padding:4px 7px 4px;">None</a>
						<a href="javascript:void(0)" id="btnRefresh" style="font-weight:normal;padding:4px 7px 4px;" class="btn success small" onclick="refresh_index()">Refresh</a>
					</div>
				</div>
			<div id="project_wrapper">
								
				<div id="treewrapper">
					<div id="tree">
						<ul>
							{{ tree_body }}
						</ul>												
					</div>
					<div id="info"></div>
				</div> 
			</div>
		</div>
		
		<!-- ARCADE -->
		<div class="content" id="arcade">
			<ul class="tabs tabs-below">
				<li class="game"><a href="#game_pacman">Pacman</a></li>
				<li class="game"><a href="#game_tetris">Tetris</a></li>
				<li class="game"><a href="#game_donkey">Donkey Kong</a></li>
			</ul>
			<div class="pill-content">
				<div class="active" id="game_pacman">
					<embed src="http://www.classicgamesarcade.com/games/pacman.swf" width="100%" height="75%" autostart="true" loop="false" controller="true" id="pacman" class="flash_game"></embed>
				</div>
				<div id="game_tetris">
					<embed src="http://www.classicgamesarcade.com/games/flash-tetris.swf" width="100%" height="75%" autostart="true" loop="false" controller="true" id="tetris" class="flash_game"></embed>
				</div>
				<div id="game_donkey">
					<embed src="http://www.classicgamesarcade.com/games/donkeykong.swf" width="100%" height="75%" autostart="true" loop="false" controller="true" id="donkey" class="flash_game"></embed>
				</div>
			</div>
		</div>

		<div id="result">
			
		</div>		
	</div>
</div> 

<form class="form-stacked" id="action_buttons">
	<fieldset style="padding-top:0px;position:relative;">
		<div class="actions">					
			<input id="btnDeploy" type="button" class="btn primary" value="Deploy to Server"  onclick='deploy()'>
			&nbsp;
			<button type="reset" class="btn" onclick="window.close();">Cancel</button>
		</div>
		<img src="{{ base_path }}/lib/ui/resources/images/big_loading.gif" style="position:absolute;top:15px;right:35px;width:36px;display:none;" id="deployment_indicator"/>
	</fieldset>
</form> 

<script type="text/javascript">
	var has_indexed_metadata = {{ has_indexed_metadata|lower }};
	var operation;
	document.title = "Deploy To Server";

	function isValidateOnly() {
		if ($("#check_only").is(":checked")) {
			return true;
		} else {
			return false;
		}
	}

	function isRunTests() {
		if ($("#run_tests").is(":checked")) {
			return true;
		} else {
			return false;
		}
	}

	function isRollbackOnError() {
		if ($("#rollback").is(":checked")) {
			return true;
		} else {
			return false;
		}
	}

	$("#save_changeset").click(function() {
		if (this.checked) {
			$("#changeset_name_wrapper").show();			
		} else {
			$("#changeset_name_wrapper").hide();
		}
	});

	function resizeWindowAfterResult() {
		window.resizeTo(800, window.innerHeight);
		window.moveTo(
			(screen.width-800)/2,
			(screen.height-document.getElementById('wrapper').offsetHeight-400)/2
			);
	}

	$(function() {
 		
		$("#check_only").change(function() {
			if (!this.checked) {
				$("#btnDeploy").val('Deploy to Server');
			} else {
				$("#btnDeploy").val('Validate Deployment');
			}
		});
		
		$("#un_list").change(function() {
			if (this.value == 'new') {
				$("#un").val("");
				$("#un").show();
			} else {
				$("#un").hide();
				$("#un").val(this.value);
			}
		});
		
		if ($("#un_list").val() != 'new') {
			$("#un").val($("#un_list").val());
		}  

		$('.tabs').tabs();

		$("#project_wrapper").height($(window).height() - 225)

		var resizeHeight = $("#form").height();
		resizeAndCenterWindowSpecific(600, resizeHeight + 250);
		$("#un_list").chosen();
		$(window).resize(function() {
			$("#project_wrapper").height($(window).height() - 225)
			$("#connections").height($(window).height() - 175)
			resize_games()
		});


		$.expr[':'].Contains = function(a, i, m) {
			return (a.textContent || a.innerText || "").toUpperCase().indexOf(m[3].toUpperCase()) >= 0;
		};

		var txtFilterTimeout = 0;
		$("#txtFilter")
		.change(function() {
			var abort_time = 150; // if it changes within this time, abort and dont filter
			if (txtFilterTimeout!=0){
				clearTimeout(txtFilterTimeout)
			}
			txtFilterTimeout = setTimeout(function(){
				var filter = $("#txtFilter").val();
		        if (filter) {
		        	$("#btnClearFilter").show()
		        	expandAll();        	
		        	filter_tree(filter);				
		        } else {
		        	$("#btnClearFilter").hide()
		        	clearFilter();
		        }
			}, abort_time);
	        //return false;
	    })
		.keyup(function() {
	        // fire the above change event after every letter	
	        $(this).change();
	    });
		
		if (!has_indexed_metadata) {
				index_org();
		} else {
			$("#tree").dynatree({
				persist: false,
				checkbox: true,
				selectMode: 3
			});
			$("#tree").dynatree("getRoot").visit(function(node) {
        		node.expand(false);
    		});  
			rootNode = $("#tree").dynatree("getRoot");
		}

	});

	function repopulate_connection_list(conns) {
		console.log('repopping')
		var connHtml = ''
		for (c in conns) {
			connHtml += '<option value="'+conns[c]['username']+';'+conns[c]['environment']+';'+conns[c]['id']+'">'
			connHtml += conns[c]['username']
			connHtml += '</option>'
		}
		//$("#no-connections").hide()
		console.log(connHtml)
		$("#un_list").html(connHtml)
		$('#un_list').trigger("liszt:updated");
	}

	function filter_tree(searchTerm) {
		var regex = new RegExp(searchTerm,"i");
		rootNode.visit(function(node) {
			if (node.isVisible() && node.data.title) {
				nodeTitle = node.data.title;
				if ( nodeTitle.match(regex) ) {
					node.visitParents(function(node) {
						$(node.li).show();
						return (node.parent != null);
					}, true); 
					return 'skip';  
				} else {
					$(node.li).hide();
				}
			}
		});
	}

	function expandAll() {
		$("#tree").dynatree("getRoot").visit(function(node){
			node.expand(true);
		});
	}

	function collapseAll() {
		$("#tree").dynatree("getRoot").visit(function(node){
			node.expand(false);
		});
	}

	function clearFilter() {
		$('#txtFilter').val('');
		$("#btnClearFilter").css({opacity: 0.0, visibility: "visible"});
		collapseAll();
		$(".dynatree-container li").show(); 
		$('#txtFilter').focus();
	}

	$("#btnDeselectAll").click(function(){
		$("#tree").dynatree("getRoot").visit(function(node){   		
			if ($(node.li).css('display') != 'none') { 
				try {
					if (node.data.level > 1)
						node.select(false);
				} catch(e) {
					node.select(false);   				
				}
			}
		});
		return false;
	});
	$("#btnSelectAll").click(function(){
		$("#tree").dynatree("getRoot").visit(function(node){		   			
			if ($(node.li).css('display') != 'none') {
				try {
					if (node.data.level > 1)
						node.select(true);
				} catch(e) {
					node.select(true);   				
				}
			}   		
		});
		return false;
	});

	var rootNode;


	function index_org(refresh) {
		console.log('indexing org')
		operation = "index"
		$.ajax({
			type: "POST",
			url: "http://127.0.0.1:9000/project/index", 
			data: JSON.stringify({
				project_name 	: '{{ name }}'
			}),
			beforeSend: function() { showLoading('Indexing your Salesforce.com metadata.  This operation could take a while depending on the size of your org.<br/><br/>Thanks for being patient! :)'); },
			complete: function(data, status, xhr){
				global_init_handler(data)				
			} 
		});
	}

	function get_target_json() {
		var targets = $("#un_list").val();
		var ts = []
		for (t in targets) {
			console.log(targets[t])
			var username = targets[t].split(';')[0]
			var type = targets[t].split(';')[1]
			var id = targets[t].split(';')[2]
			var t = {}
			t.username = username
			t.org_type = type
			t.id = id
			ts.push(t)
		}
		return ts
	}


	function handle_response(response) {
		if (operation == "deploy") {
			$("#result").html(response["body"]);

			hideElement("deployment_indicator");
			$("#btnDeploy").show();

			$(".result_table_class").height($(window).height() - 300)
			$(window).resize(function() {
		        $(".result_table_class").height($(window).height() - 300)
		    });

			if ($("#arcade").css("display") == "none") {
				$("#result_tab").click();
			    resizeWindowAfterResult();
			}
		} else if (operation == "index") {
			if (response["success"] == false) {
				$("#error_message").html(response["body"])
				$(".alert-message.error").show()
			} else {
				$("#tree").dynatree("destroy")
				$("#tree ul").html(response["body"]);
				$("#tree").dynatree({
					persist: false,
					checkbox: true,
					selectMode: 3
				});
				$("#tree").dynatree("getRoot").visit(function(node) {
	        		node.expand(false);
	    		});  
				rootNode = $("#tree").dynatree("getRoot");
			}
			hideLoading();
		}
	}

	function deploy() {
		operation = "deploy"
		$.ajax({
			type: "POST",
			url: "http://127.0.0.1:9000/project/deploy", 
			data: JSON.stringify({
				destinations 		: get_target_json(),
			    check_only 			: isValidateOnly(),
			    run_tests 			: isRunTests(),
			    rollback_on_error 	: isRollbackOnError(),
			    package 			: get_tree(),
			    project_name 		: '{{ name }}',
			    debug_categories 	: get_log_levels_json()
			}),
			beforeSend: function() { showElement("deployment_indicator"); $("#btnDeploy").hide()  },
			complete: function(data){
				global_init_handler(data)
			} 
	 	});
	} 

	function refresh_index() {
		index_org(true);
	}

	function listConnections() {
		$.ajax({
			type: "GET",
			url: "http://127.0.0.1:9000/project/conns/list", 
			data: {
				 project_name	: '{{name}}'
			},
			beforeSend: function() { showLoading('Listing connections'); },
			complete: function(data){
				//need to replace html here with list of connections
				//AND repopulate chosen multipicklist
				var connHtml = ''
				console.log(data)				
				var conns = JSON.parse(data.responseText)
				for (c in conns) {
					connHtml += '<tr>'
					connHtml += '<td>'+conns[c]['username']+' ('+conns[c]['environment']+')</td>'
					connHtml += '<td><a href="javascript:void(0);" onclick="deleteConnection(\''+conns[c]['id']+'\')">Remove</a></td>'
					connHtml += '</tr>'
				}
				repopulate_connection_list(conns)	
				$("#connections_list").html(connHtml)
				hideLoading()			
			}
	 	});
	}

	function deleteConnection(id) {
		$.ajax({
			type: "POST",
			dataType: 'json',
			contentType: 'application/json; charset=utf-8',
			url: "http://127.0.0.1:9000/project/conns/delete", 
			data: JSON.stringify({
				project_name	: '{{name}}',
				id 				: id
			}),
			beforeSend: function() { showLoading('Removing connection'); },
			complete: function(data){
				$("#error p").html('')
				console.log(data)				
				var response = JSON.parse(data.responseText)
				if (response["success"] == false) {
					$("#error p").html(response["body"])
					$("#error_wrapper").show()
					hideLoading()	
				} else {
					$("#error_wrapper").hide()
					hideLoading()	
					listConnections()
				}		
			}
	 	});
	}
	
	function newConnection() {
		$.ajax({
			type: "POST",
			dataType: 'json',
			contentType: 'application/json; charset=utf-8',
			url: "http://127.0.0.1:9000/project/conns/new", 
			data: JSON.stringify({
				username 		: $("#connection_un").val(), 
				password 		: $("#connection_pw").val(), 
				org_type 		: $("#org_type").val(),
				project_name 	: '{{name}}'
			}),
			beforeSend: function() { showLoading('Adding connection'); },
			complete: function(data){
				$("#error p").html('')
				console.log(data)				
				var response = JSON.parse(data.responseText)
				if (response["success"] == false) {
					$("#error p").html(response["body"])
					$("#error_wrapper").show()
					hideLoading()	
				} else {
					$("#connection_un").val('')
					$("#connection_pw").val('')
					$("#error_wrapper").hide()
					hideLoading()	
					listConnections()
				}
			}
	 	});
	}


</script>

{% endblock %}