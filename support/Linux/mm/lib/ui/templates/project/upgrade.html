{% extends "layouts/base.html" %}
{% block yield %}
<div id="result_output" class="error">
	<div id="result_wrapper" style="padding:0px 10px;">
		<div class="alert-message" style="display:none;">
			<p id="message"></p>
		</div>		
	</div>
</div>


<div class="content">
	
	<ul class="tabs">
		<li class="active"><a id="project_details_tab" href="#form">Project Details</a></li>
	</ul>
	
	<div class="pill-content">  
		<div id="form" class="active">
			<div class="alert-message info">
				<p>This project was created using an older version of MavensMate. Please re-enter your credentials to upgrade the project.</p>
			</div>
			<form class="form-stacked">
				<fieldset>
					<div class="clearfix">
						<label for="pn">Project Name</label> 
						<input class="xlarge" size="100" type="text" id="pn">
					</div>
					<div class="clearfix">
						<label for="un">Salesforce Username</label> 
						<input class="xlarge" size="100" type="text" id="un">
					</div>
					<div class="clearfix">
						<label for="pw">Salesforce Password</label> 
						<input class="xlarge" size="100" type="password" id="pw">
					</div>
					<div class="clearfix">
						<label for="server_url">Org Type</label> 
						<select id="org_type">
							<option value="production">Production</option>
							<option value="developer">Developer</option>
							<option value="sandbox">Sandbox</option>
							<option value="prerelease">Prerelease</option>
						</select>
					</div>											
				</fieldset>
			</form>
		</div>
	</div>
</div>  
	
<form class="form-stacked" id="action_buttons">
	<fieldset style="padding-top:0px;">
		<div class="actions">					
			<input type="button" id="btnSubmit" class="btn primary" value="Upgrade Project"  onclick="upgrade();">
			&nbsp;
			<button id="btnCancel" type="reset" class="btn" onclick="window.close();">Cancel</button>
		</div>
	</fieldset>
</form>   

	
	<script type="text/javascript">
		var mm_cpd = '{{ project_location }}';
		
		function upgrade() {
			$.ajax({
				type: "POST",
				url: "http://127.0.0.1:9000/project/upgrade", 
				dataType: 'json',
				contentType: 'application/json; charset=utf-8',
				data: JSON.stringify({
					username 			: $("#un").val(),
			    	password 			: $("#pw").val(),
			    	org_type 			: $("#org_type").val(),
			    	override_session	: true,
			    	defer_connection 	: true,
			    	project_name 		: '{{ name }}' 
				}),
				beforeSend: function() { showLoading('Updating project credentials'); },
				complete: function(data){	
					global_init_handler(data)			
				} 
			});
		}

		function handle_response(response) {
			if (response["success"] == false) {
				$(".alert-message").removeClass("success").addClass("error")
				$("#message").html(response["body"])
				$(".alert-message").show()
			} else {
				$("#btnSubmit").remove()
				$("#btnCancel").html("Done")
				$(".alert-message").addClass("success").removeClass("error")
				$("#message").html("Your project has been successfully upgraded!")
				$(".alert-message").show()
			}
			hideLoading();
		}
			
		$(function() {		   
			//instantiate tabs
			$('.tabs').tabs();
			
			var resizeHeight = $("#form").height(); 
		    resizeAndCenterWindowByHeight(resizeHeight + 200);

			$("#pn").val("{{ name }}");  
			$("#un").val("");
			$("#pw").val("");
			$("#org_type").val("");
			
			$("#pn").prop('disabled', true);  
			 				
		});	

	</script>

{% endblock %}